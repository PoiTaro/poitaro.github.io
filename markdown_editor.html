<!DOCTYPE html>
<html lang="ja">
<head>
    <meta name="robots" content="noindex, nofollow">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>高機能Markdownエディタ</title>
    
    <!-- Tailwind CSS with Typography Plugin -->
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+JP:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <!-- Marked.js for Markdown Preview -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <script>
        // ライトモードのみ
        document.documentElement.classList.remove('dark');

        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans JP', 'sans-serif'],
                    },
                    colors: {
                        'primary': {
                            '50': '#fffbeb',
                            '100': '#fef3c7',
                            '200': '#fde68a',
                            '300': '#fcd34d',
                            '400': '#fbbf24',
                            '500': '#f59e0b',
                            '600': '#d97706',
                            '700': '#b45309',
                            '800': '#92400e',
                            '900': '#78350f',
                            '950': '#451a03',
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Editor-specific styles */
        input[type="text"], input[type="date"], textarea { width: 100%; padding: 0.5rem; border-radius: 0.25rem; font-family: 'Noto Sans JP', sans-serif; font-size: 16px; background-color: #F5F3FF; border: 4px solid #8B5CF6; transition: box-shadow 0.2s, border-color 0.2s; }
        input[type="text"]:focus, input[type="date"]:focus, textarea:focus { outline: none; border-color: #6D28D9; box-shadow: 0 0 0 4px rgba(167, 139, 250, 0.5); }
        textarea#markdown-input { min-height: 400px; resize: vertical; font-family: monospace; font-size: 16px; }
        input[type="color"] { width: 50px; height: 30px; padding: 0; border: none; cursor: pointer; }
        .blog-btn { font-family: 'Inter', sans-serif; border: none; border-radius: 10px; padding: 0.5rem 1rem; font-size: 0.9rem; cursor: pointer; transition: all 0.1s ease-in-out; }
        .blog-btn.active { background-color: #f59e0b !important; }
        .file-ops-btn { padding: 0.75rem 1.5rem; font-size: 1rem; border-radius: 50px; }
        .markdown-preview { background-color: rgba(255, 255, 255, 0.8); backdrop-filter: blur(4px); padding: 1.5rem; border-radius: 0.5rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); min-height: 150px; overflow-wrap: break-word; border: 4px dashed #f59e0b; }
        .form-group { margin-bottom: 0.75rem; }
        .form-group label { display: block; font-weight: bold; margin-bottom: 0.25rem; font-family: 'Noto Sans JP', sans-serif; }

        /* Typography-Plugin-Styles */
        .prose h2 {
            border-bottom: 2px solid #fde68a;
            padding-bottom: 0.5rem;
        }
        .dark .prose h2 {
            border-bottom-color: #78350f;
        }
        .prose blockquote {
            font-style: normal;
            border-left-width: 4px;
        }
    </style>
</head>
<body class="bg-white dark:bg-gray-900 font-sans text-gray-700 dark:text-gray-300 antialiased">

    <main class="container mx-auto px-2 py-4 md:px-4">
        <div id="layout-toggle" class="mb-4 flex justify-center gap-2" style="margin-top:30px;">
            <button id="btn-split-view" class="blog-btn bg-primary-500 hover:bg-primary-600 text-white text-sm md:text-base px-3 py-2">分割ビュー</button>
            <button id="btn-tab-view" class="blog-btn bg-secondary-500 hover:bg-secondary-600 text-white ml-2 text-sm md:text-base px-3 py-2 active">タブビュー</button>
        </div>

        <!-- Tab View -->
        <div id="tab-view">
            <div class="flex border-b bg-white dark:bg-gray-900 fixed top-0 left-0 right-0 z-50">
                <button id="tab-editor" class="px-4 py-2 bg-gray-100 dark:bg-gray-800 text-gray-900 dark:text-white border-r">エディタ</button>
                <button id="tab-preview" class="px-4 py-2 bg-white dark:bg-gray-900 text-gray-500 dark:text-gray-400">プレビュー</button>
            </div>
            <div id="tab-editor-content" class="p-4 pt-16">
            </div>
            <div id="tab-preview-content" class="p-4 pt-16 hidden">
            </div>
        </div>

        <!-- Split View -->
        <div id="split-view" class="hidden grid grid-cols-1 md:grid-cols-2 gap-6">
            <section>
                <h2 class="text-xl font-semibold mb-2 text-gray-900 dark:text-white">記事情報 (Frontmatter)</h2>
                <div class="bg-white dark:bg-gray-800 p-4 rounded-lg shadow-md mb-4">
                    <div class="form-group"><label for="fm-title" class="text-gray-900 dark:text-white">タイトル:</label><input type="text" id="fm-title" placeholder="記事のタイトル" class="dark:bg-gray-700 dark:text-white"></div>
                    <div class="form-group"><label for="fm-date" class="text-gray-900 dark:text-white">日付:</label><input type="date" id="fm-date" class="dark:bg-gray-700 dark:text-white"></div>
                    <div class="form-group"><label for="fm-image" class="text-gray-900 dark:text-white">画像URL:</label><input type="text" id="fm-image" placeholder="https://example.com/image.jpg" class="dark:bg-gray-700 dark:text-white"></div>
                    <div class="form-group"><label for="fm-category" class="text-gray-900 dark:text-white">カテゴリ:</label><input type="text" id="fm-category" placeholder="例: イベント, グッズ" class="dark:bg-gray-700 dark:text-white"></div>
                    <div class="form-group flex items-center"><label for="fm-categoryColor" class="mr-2 text-gray-900 dark:text-white">カテゴリ色:</label><input type="text" id="fm-categoryColor" class="flex-grow dark:bg-gray-700 dark:text-white" placeholder="例: blue, red, green"><input type="color" id="fm-colorPicker" class="ml-2" value="#4299e1"></div>
                    <div class="form-group"><label for="fm-description" class="text-gray-900 dark:text-white">説明 (description):</label><textarea id="fm-description" rows="2" placeholder="記事の簡単な説明" class="dark:bg-gray-700 dark:text-white"></textarea></div>
                    <div class="form-group"><label for="fm-tags" class="text-gray-900 dark:text-white">タグ (カンマ区切り):</label><input type="text" id="fm-tags" placeholder="例: サンプル, Markdown, テスト" class="dark:bg-gray-700 dark:text-white"></div>
                </div>

                <h2 class="text-xl font-semibold mb-2 text-gray-900 dark:text-white">Markdown入力</h2>
                <!-- Toolbar -->
                <div class="bg-gray-100 dark:bg-gray-800 p-2 rounded-lg mb-2">
                    <!-- Headings Row -->
                    <div class="flex flex-wrap gap-1 mb-2 items-center">
                        <span class="text-xs text-gray-600 dark:text-gray-400 mr-2 font-medium">見出し:</span>
                        <button id="btn-h1" class="blog-btn bg-green-600 hover:bg-green-700 text-white text-xs px-2 py-1" title="見出し1">H1</button>
                        <button id="btn-h2" class="blog-btn bg-green-600 hover:bg-green-700 text-white text-xs px-2 py-1" title="見出し2">H2</button>
                        <button id="btn-h3" class="blog-btn bg-green-600 hover:bg-green-700 text-white text-xs px-2 py-1" title="見出し3">H3</button>
                    </div>
                    <!-- Formatting Row -->
                    <div class="flex flex-wrap gap-1 mb-2 items-center">
                        <span class="text-xs text-gray-600 dark:text-gray-400 mr-2 font-medium">書式:</span>
                        <button id="btn-bold" class="blog-btn bg-primary-600 hover:bg-primary-700 text-white text-xs px-2 py-1" title="太字"><b>B</b></button>
                        <button id="btn-italic" class="blog-btn bg-primary-600 hover:bg-primary-700 text-white text-xs px-2 py-1" title="斜体"><i>I</i></button>
                        <button id="btn-strike" class="blog-btn bg-primary-600 hover:bg-primary-700 text-white text-xs px-2 py-1" title="打ち消し線"><s>S</s></button>
                        <button id="btn-linebreak" class="blog-btn bg-blue-600 hover:bg-blue-700 text-white text-xs px-2 py-1" title="改行">⏎</button>
                    </div>
                    <!-- Elements Row -->
                    <div class="flex flex-wrap gap-1 items-center">
                        <span class="text-xs text-gray-600 dark:text-gray-400 mr-2 font-medium">要素:</span>
                        <button id="btn-link" class="blog-btn bg-primary-600 hover:bg-primary-700 text-white text-xs px-2 py-1" title="リンク">Link</button>
                        <button id="btn-image" class="blog-btn bg-primary-600 hover:bg-primary-700 text-white text-xs px-2 py-1" title="画像">Img</button>
                        <button id="btn-code" class="blog-btn bg-primary-600 hover:bg-primary-700 text-white text-xs px-2 py-1" title="コード">Code</button>
                        <button id="btn-quote" class="blog-btn bg-primary-600 hover:bg-primary-700 text-white text-xs px-2 py-1" title="引用">Quote</button>
                        <button id="btn-table" class="blog-btn bg-primary-600 hover:bg-primary-700 text-white text-xs px-2 py-1" title="表">Table</button>
                    </div>
                </div>
                <textarea id="markdown-input" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 dark:bg-gray-800 dark:text-white" placeholder="ここにMarkdownを記述してください..."></textarea>
                <div class="mt-4 bg-gray-100 dark:bg-gray-800 p-4 rounded-lg">
                    <h3 class="text-lg font-semibold mb-2 text-gray-900 dark:text-white">検索・置換</h3>
                    <div class="flex flex-wrap gap-2 mb-2">
                        <input type="text" id="search-input" placeholder="検索するテキスト" class="flex-grow p-2 border border-gray-300 rounded-lg dark:bg-gray-700 dark:text-white">
                        <input type="text" id="replace-input" placeholder="置換するテキスト" class="flex-grow p-2 border border-gray-300 rounded-lg dark:bg-gray-700 dark:text-white">
                    </div>
                    <div class="flex gap-2">
                        <button id="btn-search" class="blog-btn bg-blue-500 hover:bg-blue-600 text-white">検索</button>
                        <button id="btn-replace" class="blog-btn bg-orange-500 hover:bg-orange-600 text-white">置換</button>
                        <button id="btn-replace-all" class="blog-btn bg-red-500 hover:bg-red-600 text-white">すべて置換</button>
                    </div>
                </div>
                <div class="flex flex-wrap gap-2 mt-4">
                    <button id="btn-file-open" class="blog-btn file-ops-btn bg-blue-500 hover:bg-blue-600 text-white">ファイルを開く</button>
                    <input type="file" id="file-input" accept=".md" class="hidden">
                    <button id="btn-template" class="blog-btn file-ops-btn bg-indigo-500 hover:bg-indigo-600 text-white">テンプレート</button>
                    <button id="btn-history" class="blog-btn file-ops-btn bg-teal-500 hover:bg-teal-600 text-white">履歴</button>
                    <button id="btn-reset" class="blog-btn file-ops-btn bg-red-500 hover:bg-red-600 text-white">リセット</button>
                    <button id="btn-copy" class="blog-btn file-ops-btn bg-green-500 hover:bg-green-600 text-white">全文をコピー</button>
                    <button id="btn-download" class="blog-btn file-ops-btn bg-purple-500 hover:bg-purple-600 text-white">.mdでダウンロード</button>
                </div>
            </section>

            <section>
                <h2 class="text-xl font-semibold mb-2 text-gray-900 dark:text-white">プレビュー</h2>
                <div id="preview-area" class="markdown-preview prose lg:prose-xl max-w-none dark:prose-invert"></div>
            </section>
        </div>
    </main>

    <footer class="bg-gray-100 dark:bg-gray-950">
        <div class="container mx-auto px-6 py-12 text-center text-gray-500 dark:text-gray-400">
            <p>&copy; 2025 ポイ活Pay太郎. All Rights Reserved.</p>
        </div>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const markdownInput = document.getElementById('markdown-input');
            const previewArea = document.getElementById('preview-area');
            const fmTitle = document.getElementById('fm-title');
            const fmDate = document.getElementById('fm-date');
            const fmImage = document.getElementById('fm-image');
            const fmCategory = document.getElementById('fm-category');
            const fmCategoryColor = document.getElementById('fm-categoryColor');
            const fmDescription = document.getElementById('fm-description');
            const fmTags = document.getElementById('fm-tags');
            const fmColorPicker = document.getElementById('fm-colorPicker');
            const btnBold = document.getElementById('btn-bold');
            const btnItalic = document.getElementById('btn-italic');
            const btnStrike = document.getElementById('btn-strike');
            const btnH1 = document.getElementById('btn-h1');
            const btnH2 = document.getElementById('btn-h2');
            const btnH3 = document.getElementById('btn-h3');
            const btnLinebreak = document.getElementById('btn-linebreak');
            const btnLink = document.getElementById('btn-link');
            const btnImage = document.getElementById('btn-image');
            const btnCode = document.getElementById('btn-code');
            const btnQuote = document.getElementById('btn-quote');
            const btnTable = document.getElementById('btn-table');
            const btnFileOpen = document.getElementById('btn-file-open');
            const fileInput = document.getElementById('file-input');
            const btnReset = document.getElementById('btn-reset');
            const btnCopy = document.getElementById('btn-copy');
            const btnDownload = document.getElementById('btn-download');
            const btnTemplate = document.getElementById('btn-template');
            const btnHistory = document.getElementById('btn-history');
            const searchInput = document.getElementById('search-input');
            const replaceInput = document.getElementById('replace-input');
            const btnSearch = document.getElementById('btn-search');
            const btnReplace = document.getElementById('btn-replace');
            const btnReplaceAll = document.getElementById('btn-replace-all');
            const btnSplitView = document.getElementById('btn-split-view');
            const btnTabView = document.getElementById('btn-tab-view');
            const layoutToggle = document.getElementById('layout-toggle');
            const tabView = document.getElementById('tab-view');
            const splitView = document.getElementById('split-view');
            const tabEditor = document.getElementById('tab-editor');
            const tabPreview = document.getElementById('tab-preview');
            const tabEditorContent = document.getElementById('tab-editor-content');
            const tabPreviewContent = document.getElementById('tab-preview-content');

            const LOCAL_STORAGE_KEY = 'markdownEditorContent';

            // Debounce function for preview update
            const debounce = (func, delay) => {
                let timeoutId;
                return (...args) => {
                    clearTimeout(timeoutId);
                    timeoutId = setTimeout(() => func.apply(null, args), delay);
                };
            };

            const updatePreview = debounce(() => {
                // Get current active preview area (split view or tab view)
                const currentPreviewArea = splitView.classList.contains('hidden')
                    ? tabPreviewContent.querySelector('#preview-area')
                    : previewArea;

                if (marked && currentPreviewArea) {
                    currentPreviewArea.innerHTML = marked.parse(markdownInput.value);
                }
            }, 300);

            const saveContent = () => {
                const content = { title: fmTitle.value, date: fmDate.value, image: fmImage.value, category: fmCategory.value, categoryColor: fmCategoryColor.value, description: fmDescription.value, tags: fmTags.value, markdownBody: markdownInput.value };
                localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(content));
            };

            // Auto-save every 5 seconds
            setInterval(saveContent, 5000);

            // Version history
            const HISTORY_KEY = 'markdownEditorHistory';
            let history = JSON.parse(localStorage.getItem(HISTORY_KEY) || '[]');

            const saveToHistory = () => {
                const currentContent = {
                    title: fmTitle.value,
                    date: fmDate.value,
                    image: fmImage.value,
                    category: fmCategory.value,
                    categoryColor: fmCategoryColor.value,
                    description: fmDescription.value,
                    tags: fmTags.value,
                    markdownBody: markdownInput.value,
                    timestamp: new Date().toISOString()
                };
                history.unshift(currentContent);
                if (history.length > 20) history.pop(); // Keep only last 20 versions
                localStorage.setItem(HISTORY_KEY, JSON.stringify(history));
            };

            // Save to history on input
            markdownInput.addEventListener('input', debounce(saveToHistory, 2000));

            // Templates
            const templates = {
                blog: {
                    title: 'ブログ記事',
                    markdownBody: `# ブログ記事のタイトル

## 導入

この記事では、[トピック]について説明します。

## 本文

### セクション1

内容をここに記述してください。

### セクション2

- ポイント1
- ポイント2
- ポイント3

## まとめ

まとめの内容をここに記述してください。

---

*この記事は参考情報です。*`
                },
                document: {
                    title: '技術ドキュメント',
                    markdownBody: `# 技術ドキュメント

## 概要

このドキュメントは[プロジェクト/システム]の技術仕様を記載します。

## 仕様

### 要件

- 要件1
- 要件2
- 要件3

### 実装

\`\`\`javascript
// サンプルコード
function example() {
    console.log('Hello World');
}
\`\`\`

### API

| エンドポイント | メソッド | 説明 |
|---------------|---------|------|
| /api/example | GET | サンプル取得 |

## 参考資料

- [参考リンク1](https://example.com)
- [参考リンク2](https://example.com)`
                },
                guide: {
                    title: 'ガイド記事',
                    markdownBody: `# 初心者向けガイド

## このガイドについて

このガイドでは、[トピック]の基本から応用までを解説します。

## 準備

### 必要なもの

- アイテム1
- アイテム2
- アイテム3

### インストール

1. ステップ1
2. ステップ2
3. ステップ3

## 基本操作

### 基本操作1

操作の説明をここに記述してください。

### 基本操作2

操作の説明をここに記述してください。

## よくある質問

**Q: 質問1?**
A: 回答1

**Q: 質問2?**
A: 回答2

## 次のステップ

このガイドの次に学ぶべき内容：
- [関連トピック1]
- [関連トピック2]`
                }
            };

            // Load custom templates from localStorage
            const loadCustomTemplates = () => {
                const custom = localStorage.getItem('markdownCustomTemplates');
                return custom ? JSON.parse(custom) : {};
            };

            // Save custom templates to localStorage
            const saveCustomTemplates = (customTemplates) => {
                localStorage.setItem('markdownCustomTemplates', JSON.stringify(customTemplates));
            };

            // Template selection
            const selectTemplate = () => {
                const customTemplates = loadCustomTemplates();
                const allTemplates = { ...templates, ...customTemplates };
                const templateNames = Object.keys(allTemplates);

                const options = templateNames.map((name, i) => `${i + 1}. ${allTemplates[name].title}`).join('\n');
                const newOption = `\n${templateNames.length + 1}. 新規テンプレート作成`;
                const selected = prompt('テンプレートを選択してください:\n' + options + newOption, '1');

                if (!selected) return;

                const selectedNum = parseInt(selected);
                if (selectedNum && selectedNum >= 1 && selectedNum <= templateNames.length) {
                    // Apply existing template
                    const templateKey = templateNames[selectedNum - 1];
                    const template = allTemplates[templateKey];

                    // Get current active elements (split view or tab view)
                    const currentFmTitle = document.getElementById('fm-title');
                    const currentMarkdownInput = document.getElementById('markdown-input');
                    const currentFmDate = document.getElementById('fm-date');

                    if (currentFmTitle) currentFmTitle.value = template.title;
                    if (currentMarkdownInput) currentMarkdownInput.value = template.markdownBody;
                    if (currentFmDate) currentFmDate.valueAsDate = new Date();

                    updatePreview();
                    saveContent();
                    alert('テンプレートを適用しました！');
                } else if (selectedNum === templateNames.length + 1) {
                    // Create new template
                    createNewTemplate();
                }
            };

            // Create new template
            const createNewTemplate = () => {
                const currentFmTitle = document.getElementById('fm-title');
                const currentMarkdownInput = document.getElementById('markdown-input');

                const templateName = prompt('新規テンプレートの名前を入力してください:');
                if (!templateName) return;

                const customTemplates = loadCustomTemplates();
                if (customTemplates[templateName]) {
                    if (!confirm(`"${templateName}"は既に存在します。上書きしますか？`)) return;
                }

                customTemplates[templateName] = {
                    title: currentFmTitle ? currentFmTitle.value : templateName,
                    markdownBody: currentMarkdownInput ? currentMarkdownInput.value : ''
                };

                saveCustomTemplates(customTemplates);
                alert(`テンプレート"${templateName}"を保存しました！`);
            };

            // History selection
            const selectHistory = () => {
                if (history.length === 0) {
                    alert('履歴がありません。');
                    return;
                }
                const historyList = history.map((item, i) =>
                    `${i + 1}. ${item.title || '無題'} (${new Date(item.timestamp).toLocaleString()})`
                ).join('\n');
                const selected = prompt('復元するバージョンを選択してください:\n' + historyList, '1');
                if (selected && !isNaN(selected) && selected >= 1 && selected <= history.length) {
                    const version = history[selected - 1];
                    fmTitle.value = version.title || '';
                    fmDate.value = version.date || '';
                    fmImage.value = version.image || '';
                    fmCategory.value = version.category || '';
                    fmCategoryColor.value = version.categoryColor || '';
                    fmDescription.value = version.description || '';
                    fmTags.value = version.tags || '';
                    markdownInput.value = version.markdownBody || '';
                    updatePreview();
                    saveContent();
                    alert('過去のバージョンに復元しました！');
                }
            };

            // Keyboard shortcuts
            markdownInput.addEventListener('keydown', (e) => {
                // Shift+Enter for line break
                if (e.shiftKey && e.key === 'Enter') {
                    e.preventDefault();
                    const cursorPos = markdownInput.selectionStart;
                    const textBefore = markdownInput.value.substring(0, cursorPos);
                    const textAfter = markdownInput.value.substring(cursorPos);
                    markdownInput.value = textBefore + '<br>\n' + textAfter;
                    markdownInput.selectionStart = cursorPos + 5; // <br>\n is 5 characters
                    markdownInput.selectionEnd = cursorPos + 5;
                    updatePreview(); saveContent();
                    return;
                }

                if (e.ctrlKey || e.metaKey) {
                    switch (e.key) {
                        case 'b':
                            e.preventDefault();
                            wrapText('**', '**', '太字');
                            break;
                        case 'i':
                            e.preventDefault();
                            wrapText('*', '*', '斜体');
                            break;
                        case 's':
                            if (e.shiftKey) {
                                e.preventDefault();
                                wrapText('~~', '~~', '打ち消し線');
                            } else {
                                e.preventDefault();
                                saveContent();
                                alert('保存しました！');
                            }
                            break;
                        case '1':
                        case '2':
                        case '3':
                        case '4':
                        case '5':
                        case '6':
                            e.preventDefault();
                            const level = parseInt(e.key);
                            const hashes = '#'.repeat(level) + ' ';
                            insertMarkdown(hashes, `見出し${level}`);
                            break;
                        case 'k':
                            e.preventDefault();
                            insertLink();
                            break;
                        case 'g':
                            e.preventDefault();
                            insertImage();
                            break;
                        case 'q':
                            e.preventDefault();
                            insertMarkdown('> ', '引用');
                            break;
                        case 'm':
                            e.preventDefault();
                            insertTable();
                            break;
                    }
                }
            });

            // Drag and drop for file upload
            markdownInput.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'copy';
            });

            markdownInput.addEventListener('drop', (e) => {
                e.preventDefault();
                const files = e.dataTransfer.files;
                if (files.length > 0) {
                    const file = files[0];
                    if (file.type === 'text/markdown' || file.name.endsWith('.md')) {
                        const reader = new FileReader();
                        reader.onload = (e) => parseAndLoadMarkdown(e.target.result);
                        reader.readAsText(file);
                    } else {
                        alert('Markdownファイルのみ対応しています。');
                    }
                }
            });

            // Search and replace functionality
            let searchIndex = -1;
            const searchText = () => {
                const text = searchInput.value;
                if (!text) return;
                const content = markdownInput.value;
                const index = content.indexOf(text, searchIndex + 1);
                if (index !== -1) {
                    searchIndex = index;
                    markdownInput.focus();
                    markdownInput.selectionStart = index;
                    markdownInput.selectionEnd = index + text.length;
                } else {
                    alert('見つかりませんでした。');
                    searchIndex = -1;
                }
            };

            const replaceText = () => {
                const text = searchInput.value;
                const replace = replaceInput.value;
                if (!text) return;
                const content = markdownInput.value;
                if (markdownInput.selectionStart !== markdownInput.selectionEnd) {
                    const start = markdownInput.selectionStart;
                    const end = markdownInput.selectionEnd;
                    const selected = content.substring(start, end);
                    if (selected === text) {
                        markdownInput.value = content.substring(0, start) + replace + content.substring(end);
                        markdownInput.selectionStart = start + replace.length;
                        markdownInput.selectionEnd = start + replace.length;
                        updatePreview(); saveContent();
                        searchIndex = start;
                    }
                }
            };

            const replaceAllText = () => {
                const text = searchInput.value;
                const replace = replaceInput.value;
                if (!text) return;
                const content = markdownInput.value;
                markdownInput.value = content.replaceAll(text, replace);
                updatePreview(); saveContent();
                searchIndex = -1;
                alert('すべて置換しました。');
            };

            const wrapText = (before, after, placeholder = '') => {
                const start = markdownInput.selectionStart, end = markdownInput.selectionEnd, val = markdownInput.value;
                const selected = val.substring(start, end);
                const replacement = selected ? before + selected + after : before + placeholder + after;
                markdownInput.value = val.substring(0, start) + replacement + val.substring(end);
                markdownInput.focus();
                markdownInput.selectionStart = start + before.length;
                markdownInput.selectionEnd = start + before.length + (selected ? selected.length : placeholder.length);
                updatePreview(); saveContent();
            };

            const insertMarkdown = (syntax, placeholder) => wrapText(syntax, '', placeholder);
            const insertLink = () => { const url = prompt('リンク先のURL:', 'https://'); if (url) wrapText('[', `](${url})`, 'リンクテキスト'); };
            const insertImage = () => { const url = prompt('画像のURL:', 'https://'); if (url) insertMarkdown(`\n![画像の説明](${url})\n`, ''); };
            const insertTable = () => insertMarkdown(`\n| H1 | H2 |\n|---|---|\n| D1 | D2 |\n`, '');

            const generateFullMarkdown = () => {
                const escape = (str) => String(str || '').replace(/\\/g, '\\\\').replace(/"/g, '\"');
                const data = { title: fmTitle.value.trim(), date: fmDate.value.trim(), image: fmImage.value.trim(), category: fmCategory.value.trim(), categoryColor: fmCategoryColor.value.trim(), description: fmDescription.value.trim(), tags: fmTags.value.trim() };
                let frontmatter = '---\n';
                frontmatter += `title: "${escape(data.title)}"\n`;
                frontmatter += `date: "${data.date}"\n`;
                frontmatter += `image: "${data.image}"\n`;
                frontmatter += `category: "${escape(data.category)}"\n`;
                frontmatter += `categoryColor: "${data.categoryColor}"\n`;
                frontmatter += `description: "${escape(data.description)}"\n`;
                const tagsArray = data.tags ? data.tags.split(',').map(tag => `"${escape(tag.trim())}"`) : [];
                frontmatter += `tags: [${tagsArray.join(', ')}]\n`;
                frontmatter += '---\n\n';
                const markdownBody = markdownInput.value;
                return frontmatter + markdownBody;
            };

            const copyMarkdown = () => {
                const fullContent = generateFullMarkdown();
                navigator.clipboard.writeText(fullContent).then(() => {
                    alert('全文がクリップボードにコピーされました！');
                }, () => {
                    alert('コピーに失敗しました。ブラウザの権限を確認してください。');
                });
            };

            const resetEditor = () => {
                if (confirm('本当にリセットしますか？保存された内容も消えます。')) {
                    [fmTitle, fmImage, fmCategory, fmCategoryColor, fmDescription, fmTags, markdownInput].forEach(el => el.value = '');
                    fmDate.valueAsDate = new Date();
                    localStorage.removeItem(LOCAL_STORAGE_KEY);
                    updatePreview();
                }
            };

            const parseAndLoadMarkdown = (fullMarkdown) => {
                const match = /^---\s*([\s\S]*?)\s*---/.exec(fullMarkdown);
                let body = fullMarkdown;
                if (match) {
                    const frontmatterRaw = match[1];
                    body = fullMarkdown.substring(match[0].length).trim();
                    const attrs = {};
                    frontmatterRaw.split('\n').forEach(line => {
                        const parts = line.split(':');
                        if (parts.length >= 2) {
                            const key = parts[0].trim();
                            let value = parts.slice(1).join(':').trim().replace(/^"|"$/g, '');
                            if (key === 'tags') value = value.slice(1, -1).split(',').map(t => t.trim().replace(/^"|"$/g, '')).join(', ');
                            attrs[key] = value;
                        }
                    });
                    fmTitle.value = attrs.title || ''; fmDate.value = attrs.date || ''; fmImage.value = attrs.image || '';
                    fmCategory.value = attrs.category || ''; fmCategoryColor.value = attrs.categoryColor || '';
                    fmDescription.value = attrs.description || ''; fmTags.value = attrs.tags || '';
                }
                markdownInput.value = body;
                updatePreview(); saveContent();
            };

            const loadFile = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => parseAndLoadMarkdown(e.target.result);
                reader.readAsText(file);
            };

            const loadContent = () => {
                const saved = localStorage.getItem(LOCAL_STORAGE_KEY);
                if (saved) {
                    const content = JSON.parse(saved);
                    fmTitle.value = content.title || '';
                    fmDate.value = content.date || new Date().toISOString().split('T')[0];
                    fmImage.value = content.image || '';
                    fmCategory.value = content.category || '';
                    fmCategoryColor.value = content.categoryColor || '';
                    fmDescription.value = content.description || '';
                    fmTags.value = content.tags || '';
                    markdownInput.value = content.markdownBody || '';
                } else {
                    fmDate.valueAsDate = new Date();
                }
                updatePreview();
            };

            [...document.querySelectorAll('input, textarea')].forEach(el => el.addEventListener('input', () => { updatePreview(); saveContent(); }));
            fmColorPicker.addEventListener('input', () => { fmCategoryColor.value = fmColorPicker.value; saveContent(); });
            btnH1.addEventListener('click', () => insertMarkdown('# ', '見出し1'));
            btnH2.addEventListener('click', () => insertMarkdown('## ', '見出し2'));
            btnH3.addEventListener('click', () => insertMarkdown('### ', '見出し3'));
            btnLinebreak.addEventListener('click', () => {
                const cursorPos = markdownInput.selectionStart;
                const textBefore = markdownInput.value.substring(0, cursorPos);
                const textAfter = markdownInput.value.substring(cursorPos);
                markdownInput.value = textBefore + '<br>\n' + textAfter;
                markdownInput.selectionStart = cursorPos + 5;
                markdownInput.selectionEnd = cursorPos + 5;
                markdownInput.focus();
                updatePreview(); saveContent();
            });
            btnBold.addEventListener('click', () => wrapText('**', '**', '太字'));
            btnItalic.addEventListener('click', () => wrapText('*', '*', '斜体'));
            btnStrike.addEventListener('click', () => wrapText('~~', '~~', '打ち消し線'));
            btnLink.addEventListener('click', insertLink);
            btnImage.addEventListener('click', insertImage);
            btnCode.addEventListener('click', () => wrapText('\n```\n', '\n```', 'code'));
            btnQuote.addEventListener('click', () => insertMarkdown('> ', '引用'));
            btnTable.addEventListener('click', insertTable);
            btnFileOpen.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', loadFile);
            btnReset.addEventListener('click', resetEditor);
            btnCopy.addEventListener('click', copyMarkdown);
            btnDownload.addEventListener('click', () => {
                const fullContent = generateFullMarkdown();
                const title = fmTitle.value.trim() || 'untitled';
                const blob = new Blob([fullContent], { type: 'text/markdown;charset=utf-8' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${title}.md`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                alert('Markdownファイルがダウンロードされました！');
            });
            btnSearch.addEventListener('click', searchText);
            btnReplace.addEventListener('click', replaceText);
            btnReplaceAll.addEventListener('click', replaceAllText);
            btnTemplate.addEventListener('click', selectTemplate);
            btnHistory.addEventListener('click', selectHistory);

            // Layout toggle
            const editorSection = document.querySelector('#split-view section:first-child');
            const previewSection = document.querySelector('#split-view section:last-child');

            const switchToSplitView = () => {
                if (!tabView.classList.contains('hidden')) {
                    tabView.classList.add('hidden');
                    splitView.classList.remove('hidden');
                    btnSplitView.classList.add('active');
                    btnTabView.classList.remove('active');
                    // Move sections back to split view
                    while (tabEditorContent.firstChild) {
                        splitView.appendChild(tabEditorContent.firstChild);
                    }
                    while (tabPreviewContent.firstChild) {
                        splitView.appendChild(tabPreviewContent.firstChild);
                    }
                } else {
                    alert('すでに分割ビューです。');
                }
            };

            const switchToTabView = () => {
                splitView.classList.add('hidden');
                tabView.classList.remove('hidden');
                btnTabView.classList.add('active');
                btnSplitView.classList.remove('active');
                // Move editor section to tab-editor-content
                tabEditorContent.appendChild(editorSection);
                // Move preview section to tab-preview-content
                tabPreviewContent.appendChild(previewSection);
                // Re-bind events if necessary (but since elements are moved, events should persist)
            };

            btnSplitView.addEventListener('click', switchToSplitView);
            btnTabView.addEventListener('click', switchToTabView);

            // Scroll position storage
            let editorScrollTop = 0;
            let previewScrollTop = 0;

            // Tab switching
            tabEditor.addEventListener('click', () => {
                // Save preview scroll position
                previewScrollTop = tabPreviewContent.scrollTop;

                tabEditorContent.classList.remove('hidden');
                tabPreviewContent.classList.add('hidden');
                tabEditor.classList.add('bg-gray-100', 'dark:bg-gray-800', 'text-gray-900', 'dark:text-white');
                tabEditor.classList.remove('bg-white', 'dark:bg-gray-900', 'text-gray-500', 'dark:text-gray-400');
                tabPreview.classList.remove('bg-gray-100', 'dark:bg-gray-800', 'text-gray-900', 'dark:text-white');
                tabPreview.classList.add('bg-white', 'dark:bg-gray-900', 'text-gray-500', 'dark:text-gray-400');

                // Scroll to Markdown input area
                setTimeout(() => {
                    const markdownInput = tabEditorContent.querySelector('#markdown-input');
                    if (markdownInput) {
                        markdownInput.scrollIntoView({ behavior: 'auto', block: 'start' });
                    }
                }, 10);
            });

            tabPreview.addEventListener('click', () => {
                // Save editor scroll position
                editorScrollTop = tabEditorContent.scrollTop;
                // Restore preview scroll position
                setTimeout(() => {
                    tabPreviewContent.scrollTop = previewScrollTop;
                }, 0);

                tabPreviewContent.classList.remove('hidden');
                tabEditorContent.classList.add('hidden');
                tabPreview.classList.add('bg-gray-100', 'dark:bg-gray-800', 'text-gray-900', 'dark:text-white');
                tabPreview.classList.remove('bg-white', 'dark:bg-gray-900', 'text-gray-500', 'dark:text-gray-400');
                tabEditor.classList.remove('bg-gray-100', 'dark:bg-gray-800', 'text-gray-900', 'dark:text-white');
                tabEditor.classList.add('bg-white', 'dark:bg-gray-900', 'text-gray-500', 'dark:text-gray-400');
                updatePreview();
            });

            loadContent();
        });
    </script>
</body>
</html>
